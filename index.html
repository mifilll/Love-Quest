<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Love Quest — обновлено</title>
  <style>
    html,body{height:100%;margin:0;background:#0b1020;font-family:Inter, system-ui, sans-serif}
    #gameWrap{display:flex;align-items:center;justify-content:center;height:100%;padding:18px}
    canvas{background:linear-gradient(#ffb37a,#8fb0ff);border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.35)}

    /* UI */
    .hud{position:fixed;left:16px;top:12px;background:rgba(255,255,255,.9);padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.12);font-weight:600}
    .hint{position:fixed;right:16px;top:12px;background:rgba(255,255,255,.9);padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.06)}

    /* Mobile buttons */
    .touch-controls{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;align-items:center}
    .dpad{display:flex;gap:8px}
    .btn{width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,.95);box-shadow:0 10px 30px rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;font-size:24px;user-select:none;touch-action:manipulation}
    .btn.small{width:56px;height:56px}
    .jump-wrap{position:fixed;right:12px;bottom:20px}

    /* Overlay / menu */
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .card{width:92%;max-width:760px;background:linear-gradient(180deg,#fff,#fff);border-radius:16px;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.28);text-align:center;transform:scale(.98);opacity:0;transition:all .4s ease;pointer-events:auto}
    .card.show{opacity:1;transform:scale(1)}
    .finalPhoto{width:220px;height:220px;border-radius:14px;object-fit:cover;display:block;margin:14px auto}
    button.primary{background:#ff6b8a;border:none;color:#fff;padding:10px 18px;border-radius:10px;font-weight:700;cursor:pointer}
    .menuList{display:flex;gap:12px;justify-content:center;margin:14px 0}
    .levelBtn{background:#fff;border:2px solid #eee;padding:10px 14px;border-radius:10px;cursor:pointer}

    @media (max-width:640px){
      .btn{width:56px;height:56px}
      .jump-wrap{right:8px;bottom:12px}
    }
  </style>
</head>
<body>
  <div id="gameWrap">
    <canvas id="game" width="900" height="520"></canvas>
  </div>

  <div class="hud" id="hud">Уровень: <span id="levelNum">1</span> — Собрано: <span id="col">0</span>/<span id="colGoal">5</span></div>
  <div class="hint">Клавиши ← →, пробел — прыжок. На телефоне используйте кнопки управления.</div>

  <!-- Touch controls -->
  <div class="touch-controls" id="touchControls">
    <div class="dpad">
      <div class="btn" id="leftBtn">◀</div>
      <div class="btn" id="rightBtn">▶</div>
    </div>
  </div>
  <div class="jump-wrap">
    <div class="btn small" id="jumpBtn">⤴</div>
  </div>

  <div class="overlay">
    <div class="card" id="menuCard">
      <h1>Love Quest — выбрать уровень</h1>
      <div class="menuList">
        <button class="levelBtn" data-level="1">Уровень 1</button>
        <button class="levelBtn" data-level="2">Уровень 2</button>
        <button class="levelBtn" data-level="3">Уровень 3</button>
      </div>
      <p>Каждый уровень чуть сложнее предыдущего. После прохождения всех появится финальная карточка с фото и музыкой.</p>
      <button class="primary" id="startBtn">Начать</button>
    </div>

    <div class="card" id="final" style="display:none">
      <h1>Ты прошла все уровни!</h1>
      <img src="photo.jpg" alt="Фото" class="finalPhoto" id="finalPhoto">
      <p id="finalText">Я не знаю, как объяснить, но каждый день с тобой — мой лучший уровень ❤️</p>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="primary" id="replayBtn">Играть снова</button>
        <button class="levelBtn" id="toMenuBtn">В меню</button>
      </div>
    </div>
  </div>

  <audio id="music" src="music.mp3" preload="auto"></audio>

  <script>
  // Responsive canvas scaling
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const baseW = 900, baseH = 520;
  function resizeCanvas(){
    const maxW = Math.min(window.innerWidth - 36, baseW);
    const scale = maxW / baseW;
    canvas.style.width = Math.round(baseW * scale) + 'px';
    canvas.style.height = Math.round(baseH * scale) + 'px';
  }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();

  // World
  const W = canvas.width, H = canvas.height;

  // Player (improved boy sprite, drawn procedurally)
  const player = {x:80,y:350,w:36,h:56,vx:0,vy:0,onGround:false,facing:1};
  const gravity = 0.9, friction = 0.85;

  // Controls
  const keys = {};
  window.addEventListener('keydown', e=>{ keys[e.code]=true; if(e.code==='Space') e.preventDefault(); });
  window.addEventListener('keyup', e=>{ keys[e.code]=false; });

  // Mobile touch buttons
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const jumpBtn = document.getElementById('jumpBtn');
  let leftDown=false, rightDown=false, jumpDown=false;
  function bindTouch(el, onStart, onEnd){
    el.addEventListener('pointerdown', (e)=>{ e.preventDefault(); onStart(); });
    window.addEventListener('pointerup', (e)=>{ onEnd(); });
    el.addEventListener('pointercancel', (e)=>{ onEnd(); });
  }
  bindTouch(leftBtn, ()=>{ leftDown=true; }, ()=>{ leftDown=false; });
  bindTouch(rightBtn, ()=>{ rightDown=true; }, ()=>{ rightDown=false; });
  bindTouch(jumpBtn, ()=>{ jumpDown=true; setTimeout(()=>jumpDown=false,150); }, ()=>{ jumpDown=false; });

  // Levels data (3 levels: increase platforms and collectibles)
  const levels = [
    {
      platforms:[
        {x:0,y:460,w:900,h:60},
        {x:140,y:380,w:120,h:16},
        {x:300,y:320,w:140,h:16},
        {x:520,y:260,w:120,h:16},
        {x:700,y:200,w:160,h:16}
      ],
      pieces:[ {x:180,y:340},{x:360,y:280},{x:580,y:220},{x:760,y:160},{x:420,y:420} ]
    },
    {
      platforms:[
        {x:0,y:460,w:900,h:60},
        {x:100,y:400,w:160,h:16},
        {x:320,y:360,w:120,h:16},
        {x:480,y:300,w:100,h:16},
        {x:640,y:240,w:120,h:16},
        {x:780,y:180,w:100,h:16}
      ],
      pieces:[ {x:140,y:360},{x:360,y:340},{x:540,y:260},{x:700,y:200},{x:820,y:140} ]
    },
    {
      platforms:[
        {x:0,y:460,w:900,h:60},
        {x:120,y:420,w:100,h:16},
        {x:260,y:360,w:100,h:16},
        {x:420,y:320,w:120,h:16},
        {x:580,y:280,w:100,h:16},
        {x:720,y:220,w:120,h:16},
        {x:820,y:160,w:60,h:16}
      ],
      pieces:[ {x:150,y:380},{x:290,y:320},{x:480,y:280},{x:640,y:240},{x:820,y:120} ]
    }
  ];

  let currentLevel = 0;
  let platforms = [];
  let pieces = [];
  let finishedLevels = 0;

  // clouds for background, moving
  const clouds = [];
  for(let i=0;i<8;i++){
    clouds.push({x: i*140 + (Math.random()*60), y: 40 + Math.random()*80, speed: 0.2 + Math.random()*0.6, scale: 0.8 + Math.random()*0.8});
  }

  function loadLevel(n){
    currentLevel = n;
    document.getElementById('levelNum').textContent = (n+1);
    platforms = JSON.parse(JSON.stringify(levels[n].platforms));
    pieces = levels[n].pieces.map(p=>({...p, collected:false}));
    document.getElementById('colGoal').textContent = pieces.length;
    document.getElementById('col').textContent = pieces.filter(p=>p.collected).length;
    resetPlayer();
    finished=false;
  }

  function drawRoundedRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill(); }

  function draw(){
    ctx.clearRect(0,0,W,H);

    // sky gradient - evening sunset
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#ffdfb8');
    g.addColorStop(0.4,'#ffb37a');
    g.addColorStop(0.7,'#8fb0ff');
    g.addColorStop(1,'#223a70');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

    // sun
    ctx.beginPath(); ctx.arc(120,120,52,0,Math.PI*2); ctx.fillStyle='rgba(255,210,120,0.95)'; ctx.fill();

    // clouds (move)
    for(let c of clouds){
      ctx.save(); ctx.globalAlpha = 0.95;
      const cx = (c.x + (Date.now()*0.01*c.speed)) % (W + 200) - 100;
      const cy = c.y + Math.sin(Date.now()/1500 + c.x)*6;
      ctx.fillStyle='rgba(255,255,255,0.95)';
      drawRoundedRect(cx, cy, 120*c.scale, 40*c.scale, 20*c.scale);
      ctx.restore();
    }

    // distant hills
    ctx.fillStyle = 'rgba(20,40,80,0.18)'; ctx.beginPath(); ctx.ellipse(300,520,420,140,0,Math.PI,Math.PI*2); ctx.fill();
    ctx.fillStyle = 'rgba(20,30,60,0.12)'; ctx.beginPath(); ctx.ellipse(700,520,340,120,0,Math.PI,Math.PI*2); ctx.fill();

    // platforms
    ctx.fillStyle='#ffdede';
    for(let p of platforms){ drawRoundedRect(p.x,p.y,p.w,p.h,8); }

    // pieces (hearts)
    for(let i=0;i<pieces.length;i++){
      const s = pieces[i];
      if(s.collected) continue;
      const cx = s.x, cy = s.y;
      ctx.save(); ctx.translate(cx,cy);
      ctx.beginPath(); ctx.moveTo(0, -10); ctx.bezierCurveTo(-18,-40,-60,-6,-8,18); ctx.bezierCurveTo(10,28,28,12,28,12); ctx.bezierCurveTo(34,-6,18,-40,0,-10); ctx.closePath(); ctx.fillStyle='#ff6b8a'; ctx.fill();
      ctx.restore();
    }

    // player - boy: shadow, legs, body, shirt, head, hair, eyes
    // shadow
    ctx.fillStyle='rgba(0,0,0,0.16)'; ctx.beginPath(); ctx.ellipse(player.x+player.w/2, player.y+player.h+10, 26,8,0,0,Math.PI*2); ctx.fill();
    // legs
    ctx.fillStyle='#2d2d2d'; ctx.fillRect(player.x+6, player.y+player.h-8, 10,12); ctx.fillRect(player.x+player.w-16, player.y+player.h-8, 10,12);
    // body
    drawRoundedRect(player.x, player.y+14, player.w, player.h-22, 8);
    ctx.fillStyle='#6fb6ff'; drawRoundedRect(player.x, player.y+14, player.w, player.h-22, 8);
    // shirt stripe
    ctx.fillStyle='#fff'; ctx.fillRect(player.x+6, player.y+26, player.w-12, 8);
    // head
    ctx.fillStyle='#ffd2a6'; ctx.beginPath(); ctx.ellipse(player.x+player.w/2, player.y+12, 14,12,0,0,Math.PI*2); ctx.fill();
    // hair
    ctx.fillStyle='#2b2b2b'; ctx.beginPath(); ctx.ellipse(player.x+player.w/2-4, player.y+4, 10,8,0,0,Math.PI*2); ctx.fill();
    // eyes
    ctx.fillStyle='#111'; ctx.fillRect(player.x+10, player.y+10,3,3); ctx.fillRect(player.x+player.w-14, player.y+10,3,3);

    // small blush
    ctx.fillStyle='rgba(255,80,120,0.18)'; ctx.beginPath(); ctx.ellipse(player.x+8, player.y+14,5,3,0,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(player.x+player.w-10, player.y+14,5,3,0,0,Math.PI*2); ctx.fill();

  }

  function update(){
    // input
    if(keys['ArrowLeft'] || keys['KeyA'] || leftDown){ player.vx = Math.max(player.vx-1.2, -6); player.facing=-1; }
    if(keys['ArrowRight'] || keys['KeyD'] || rightDown){ player.vx = Math.min(player.vx+1.2, 6); player.facing=1; }
    if(!keys['ArrowLeft'] && !keys['KeyA'] && !keys['ArrowRight'] && !keys['KeyD'] && !leftDown && !rightDown) player.vx *= friction;

    if((keys['Space'] || keys['ArrowUp'] || keys['KeyW'] || jumpDown) && player.onGround){ player.vy = -15; player.onGround = false; }

    // physics
    player.vy += gravity; player.x += player.vx; player.y += player.vy;

    // bounds
    if(player.x < 0) player.x = 0; if(player.x + player.w > W) player.x = W - player.w;
    if(player.y > H){ resetPlayer(); }

    // collisions
    player.onGround = false;
    for(let p of platforms){
      if(player.x + player.w > p.x && player.x < p.x + p.w && player.y + player.h > p.y && player.y + player.h < p.y + p.h + 30 && player.vy >=0){
        player.y = p.y - player.h; player.vy = 0; player.onGround = true;
      }
    }

    // collect
    for(let s of pieces){ if(s.collected) continue; const dx = (player.x + player.w/2) - s.x; const dy = (player.y + player.h/2) - s.y; if(Math.sqrt(dx*dx+dy*dy) < 36){ s.collected=true; updateCount(); }}

    if(pieces.every(p=>p.collected)) levelFinish();
  }

  function resetPlayer(){ player.x=80; player.y=350; player.vx=0; player.vy=0; }

  function updateCount(){ document.getElementById('col').textContent = pieces.filter(p=>p.collected).length; }

  let finished=false;
  function levelFinish(){ if(finished) return; finished=true;
    // small celebration: simple popup then go to next
    setTimeout(()=>{
      finished=false;
      finishedLevels = Math.max(finishedLevels, currentLevel+1);
      if(currentLevel < levels.length-1){ loadLevel(currentLevel+1); }
      else { // all levels done
        showFinal(); }
    }, 700);
  }

  function showFinal(){ document.getElementById('final').style.display='block'; document.getElementById('final').classList.add('show'); const music = document.getElementById('music'); music.currentTime=0; music.play().catch(()=>{}); }

  // menu logic
  const menuCard = document.getElementById('menuCard'); const finalCard = document.getElementById('final');
  const startBtn = document.getElementById('startBtn'); startBtn.addEventListener('click', ()=>{ menuCard.classList.remove('show'); menuCard.style.display='none'; loadLevel(0); });
  const levelBtns = document.querySelectorAll('.levelBtn[data-level]'); levelBtns.forEach(b=>{ b.addEventListener('click', ()=>{ const idx = Number(b.dataset.level)-1; loadLevel(idx); menuCard.classList.remove('show'); menuCard.style.display='none'; }); });
  document.getElementById('replayBtn').addEventListener('click', ()=>{ // restart all
    for(let l=0;l<levels.length;l++){ /* nothing persistent */ }
    document.getElementById('final').classList.remove('show'); setTimeout(()=>{ document.getElementById('final').style.display='none'; },300); loadLevel(0); document.getElementById('music').pause(); });
  document.getElementById('toMenuBtn').addEventListener('click', ()=>{ document.getElementById('final').classList.remove('show'); setTimeout(()=>{ document.getElementById('final').style.display='none'; },300); menuCard.style.display='block'; menuCard.classList.add('show'); document.getElementById('music').pause(); });

  // initial setup: show menu
  menuCard.style.display='block'; menuCard.classList.add('show');

  function loop(){ update(); draw(); requestAnimationFrame(loop); }
  loop();

  // small mobile tap to jump as fallback
  let lastTap=0; canvas.addEventListener('touchstart', (e)=>{ const now=Date.now(); if(now-lastTap<300){ if(player.onGround) player.vy=-15; } lastTap=now; });
  </script>
</body>
</html>
