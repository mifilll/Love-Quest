<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Love Quest — обновлено v2</title>
  <style>
    html,body{height:100%;margin:0;background:#0b1020;font-family:Inter, system-ui, sans-serif}
    #gameWrap{display:flex;align-items:center;justify-content:center;height:100%;padding:18px}
    canvas{background:linear-gradient(#ffb37a,#8fb0ff);border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.35)}

    .hud{position:fixed;left:16px;top:12px;background:rgba(255,255,255,.9);padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.12);font-weight:600;z-index:10}
    .hint{position:fixed;right:16px;top:12px;background:rgba(255,255,255,.9);padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.06);z-index:10}

    .touch-controls{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;align-items:center;z-index:10}
    .btn{width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,.95);box-shadow:0 10px 30px rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;font-size:24px;user-select:none;touch-action:manipulation}
    .btn.small{width:56px;height:56px}
    .jump-wrap{position:fixed;right:12px;bottom:20px;z-index:10}

    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:100}
    .card{width:92%;max-width:760px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.28);text-align:center;transform:scale(.98);opacity:0;transition:all .4s ease;pointer-events:auto;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98)}
    .card.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
    .finalPhoto{width:220px;height:220px;border-radius:14px;object-fit:cover;display:block;margin:14px auto}
    button.primary{background:#ff6b8a;border:none;color:#fff;padding:10px 18px;border-radius:10px;font-weight:700;cursor:pointer}
    .levelBtn{background:#fff;border:2px solid #eee;padding:10px 14px;border-radius:10px;cursor:pointer}
    .menuList{display:flex;gap:12px;justify-content:center;margin:14px 0;flex-wrap:wrap}
  </style>
</head>
<body>
  <div id="gameWrap"><canvas id="game" width="900" height="520"></canvas></div>
  <div class="hud" id="hud">Уровень: <span id="levelNum">1</span> — ❤️ <span id="col">0</span>/<span id="colGoal">5</span></div>
  <div class="hint">← → пробел / ↑ — движение и прыжок</div>

  <div class="touch-controls"><div class="btn" id="leftBtn">◀</div><div class="btn" id="rightBtn">▶</div></div>
  <div class="jump-wrap"><div class="btn small" id="jumpBtn">⤴</div></div>

  <div class="overlay">
    <div class="card" id="menuCard"><h1>Love Quest</h1><p>Выбирай уровень (открываются по мере прохождения):</p><div class="menuList" id="levelsList"></div><button class="primary" id="startBtn">Начать с начала</button></div>
    <div class="card" id="nextLevelCard" style="display:none"><h1>Уровень пройден!</h1><p>Хочешь продолжить?</p><button class="primary" id="nextBtn">Далее ▶</button> <button class="levelBtn" id="backToMenu">В меню</button></div>
    <div class="card" id="finalCard" style="display:none"><h1>Ты прошла все уровни!</h1><img src="photo.jpg" alt="Фото" class="finalPhoto"><p>Я не знаю, как объяснить, но каждый день с тобой — мой лучший уровень ❤️</p><button class="primary" id="replayBtn">Играть снова</button></div>
  </div>

  <audio id="music" src="music.mp3" preload="auto"></audio>

  <script>
  const canvas=document.getElementById('game');const ctx=canvas.getContext('2d');const W=canvas.width,H=canvas.height;
  const player={x:80,y:350,w:36,h:56,vx:0,vy:0,onGround:false,facing:1,lives:3};
  const gravity=0.9,friction=0.85;
  let currentLevel=0,levelsUnlocked=1,finished=false;

  const levels=[
    {platforms:[{x:0,y:460,w:900,h:60},{x:160,y:380,w:120,h:16},{x:340,y:320,w:160,h:16},{x:560,y:260,w:140,h:16},{x:740,y:200,w:140,h:16}],pieces:[{x:200,y:340},{x:380,y:280},{x:580,y:220},{x:760,y:160},{x:460,y:420}]},
    {platforms:[{x:0,y:460,w:900,h:60},{x:120,y:400,w:160,h:16},{x:340,y:340,w:120,h:16},{x:540,y:280,w:120,h:16},{x:720,y:220,w:160,h:16}],pieces:[{x:160,y:360},{x:360,y:300},{x:580,y:260},{x:760,y:200},{x:440,y:420}]},
    {platforms:[{x:0,y:460,w:900,h:60},{x:100,y:420,w:120,h:16},{x:260,y:360,w:100,h:16},{x:420,y:320,w:120,h:16},{x:580,y:280,w:120,h:16},{x:740,y:220,w:100,h:16},{x:840,y:160,w:80,h:16}],pieces:[{x:140,y:380},{x:300,y:320},{x:460,y:280},{x:640,y:240},{x:820,y:120}]}];

  let platforms=[],pieces=[],lives=3;
  const music=document.getElementById('music');

  function resetPlayer(){player.x=80;player.y=350;player.vx=0;player.vy=0;player.onGround=false;}
  function loadLevel(n){currentLevel=n;platforms=JSON.parse(JSON.stringify(levels[n].platforms));pieces=levels[n].pieces.map(p=>({...p,collected:false}));resetPlayer();updateCount();document.getElementById('levelNum').textContent=n+1;document.getElementById('colGoal').textContent=pieces.length;document.getElementById('col').textContent=0;}

  const keys={};window.addEventListener('keydown',e=>{keys[e.code]=true;if(e.code==='Space')e.preventDefault();});window.addEventListener('keyup',e=>{keys[e.code]=false;});

  const leftBtn=document.getElementById('leftBtn'),rightBtn=document.getElementById('rightBtn'),jumpBtn=document.getElementById('jumpBtn');let left=false,right=false,jump=false;
  function bind(b,fn1,fn2){b.addEventListener('pointerdown',e=>{e.preventDefault();fn1();});window.addEventListener('pointerup',fn2);}bind(leftBtn,()=>left=true,()=>left=false);bind(rightBtn,()=>right=true,()=>right=false);bind(jumpBtn,()=>jump=true,()=>jump=false);

  function draw(){ctx.clearRect(0,0,W,H);const g=ctx.createLinearGradient(0,0,0,H);g.addColorStop(0,'#ffdfb8');g.addColorStop(0.4,'#ffb37a');g.addColorStop(0.7,'#8fb0ff');g.addColorStop(1,'#223a70');ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#ffdede';for(let p of platforms){ctx.fillRect(p.x,p.y,p.w,p.h);}for(let s of pieces){if(!s.collected){ctx.beginPath();ctx.moveTo(s.x,s.y-10);ctx.bezierCurveTo(s.x-18,s.y-40,s.x-60,s.y-6,s.x-8,s.y+18);ctx.bezierCurveTo(s.x+10,s.y+28,s.x+28,s.y+12,s.x+28,s.y+12);ctx.bezierCurveTo(s.x+34,s.y-6,s.x+18,s.y-40,s.x,s.y-10);ctx.closePath();ctx.fillStyle='#ff6b8a';ctx.fill();}}
    ctx.fillStyle='rgba(0,0,0,0.16)';ctx.beginPath();ctx.ellipse(player.x+player.w/2,player.y+player.h+10,26,8,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='#6fb6ff';ctx.fillRect(player.x,player.y+14,player.w,player.h-22);ctx.fillStyle='#fff';ctx.fillRect(player.x+6,player.y+26,player.w-12,8);ctx.fillStyle='#ffd2a6';ctx.beginPath();ctx.ellipse(player.x+player.w/2,player.y+12,14,12,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='#2b2b2b';ctx.beginPath();ctx.ellipse(player.x+player.w/2-4,player.y+4,10,8,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='#111';ctx.fillRect(player.x+10,player.y+10,3,3);ctx.fillRect(player.x+player.w-14,player.y+10,3,3);}

  function update(){if(keys['ArrowLeft']||keys['KeyA']||left){player.vx=Math.max(player.vx-1.2,-6);}if(keys['ArrowRight']||keys['KeyD']||right){player.vx=Math.min(player.vx+1.2,6);}if(!keys['ArrowLeft']&&!keys['KeyA']&&!keys['ArrowRight']&&!keys['KeyD']&&!left&&!right)player.vx*=friction;if((keys['Space']||keys['ArrowUp']||keys['KeyW']||jump)&&player.onGround){player.vy=-15;player.onGround=false;jump=false;}player.vy+=gravity;player.x+=player.vx;player.y+=player.vy;if(player.x<0)player.x=0;if(player.x+player.w>W)player.x=W-player.w;if(player.y>H){loseLife();}
    player.onGround=false;for(let p of platforms){if(player.x+player.w>p.x&&player.x<p.x+p.w&&player.y+player.h>p.y&&player.y+player.h<p.y+p.h+30&&player.vy>=0){player.y=p.y-player.h;player.vy=0;player.onGround=true;}}
    for(let s of pieces){if(s.collected)continue;const dx=player.x+player.w/2-s.x,dy=player.y+player.h/2-s.y;if(Math.sqrt(dx*dx+dy*dy)<36){s.collected=true;updateCount();}}
    if(pieces.every(p=>p.collected))levelComplete();}

  function loseLife(){player.lives--;if(player.lives<=0){showMenu();player.lives=3;music.pause();music.currentTime=0;}else resetPlayer();}

  function updateCount(){document.getElementById('col').textContent=pieces.filter(p=>p.collected).length;}
  function levelComplete(){if(finished)return;finished=true;setTimeout(()=>{finished=false;if(currentLevel<levels.length-1){if(levelsUnlocked<currentLevel+2)levelsUnlocked=currentLevel+2;showNext();}else showFinal();},700);}

  function showMenu(){hideAll();document.getElementById('menuCard').style.display='block';document.getElementById('menuCard').classList.add('show');refreshMenu();}
  function showNext(){hideAll();const c=document.getElementById('nextLevelCard');c.style.display='block';c.classList.add('show');}
  function showFinal(){hideAll();const f=document.getElementById('finalCard');f.style.display='block';f.classList.add('show');music.currentTime=0;music.loop=false;music.play().catch(()=>{});}
  function hideAll(){document.querySelectorAll('.card').forEach(c=>{c.classList.remove('show');c.style.display='none';});}

  function refreshMenu(){const list=document.getElementById('levelsList');list.innerHTML='';for(let i=0;i<levels.length;i++){const b=document.createElement('button');b.className='levelBtn';b.textContent='Уровень '+(i+1);b.disabled=i>=levelsUnlocked;b.style.opacity=i>=levelsUnlocked?'0.5':'1';b.onclick=()=>{hideAll();loadLevel(i);};list.appendChild(b);} }

  document.getElementById('startBtn').onclick=()=>{levelsUnlocked=1;hideAll();loadLevel(0);};
  document.getElementById('nextBtn').onclick=()=>{hideAll();loadLevel(currentLevel+1);};
  document.getElementById('backToMenu').onclick=()=>{showMenu();};
  document.getElementById('replayBtn').onclick=()=>{music.pause();music.currentTime=0;levelsUnlocked=1;showMenu();};

  function loop(){update();draw();requestAnimationFrame(loop);}loadLevel(0);loop();
  showMenu();
  </script>
</body>
</html>
