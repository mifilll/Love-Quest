<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Love Quest — Full v2</title>
  <style>
    html,body{height:100%;margin:0;background:#0b1020;font-family:Inter, system-ui, sans-serif}
    #gameWrap{display:flex;align-items:center;justify-content:center;height:100%;padding:18px}
    canvas{background:linear-gradient(#ffb37a,#8fb0ff);border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.35)}
    .hud{position:fixed;left:16px;top:12px;background:rgba(255,255,255,.95);padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.12);font-weight:700;z-index:20}
    .hint{position:fixed;right:16px;top:12px;background:rgba(255,255,255,.95);padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.06);z-index:20}
    .touch-controls{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;align-items:center;z-index:20}
    .btn{width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,.95);box-shadow:0 10px 30px rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;font-size:24px;user-select:none;touch-action:manipulation}
    .btn.small{width:56px;height:56px}
    .jump-wrap{position:fixed;right:12px;bottom:20px;z-index:20}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:50}
    .card{width:92%;max-width:760px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.28);text-align:center;pointer-events:auto;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);opacity:0;transition:all .25s ease}
    .card.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
    .finalPhoto{width:220px;height:220px;border-radius:14px;object-fit:cover;display:block;margin:14px auto}
    button.primary{background:#ff6b8a;border:none;color:#fff;padding:10px 18px;border-radius:10px;font-weight:700;cursor:pointer}
    .levelBtn{background:#fff;border:2px solid #eee;padding:10px 14px;border-radius:10px;cursor:pointer}
    .menuList{display:flex;gap:12px;justify-content:center;margin:14px 0;flex-wrap:wrap}
    .hearts{display:inline-flex;gap:6px;vertical-align:middle}
    @media (max-width:640px){.btn{width:56px;height:56px}}
  </style>
</head>
<body>
  <div id="gameWrap"><canvas id="game" width="900" height="520"></canvas></div>

  <div class="hud" id="hud">Уровень: <span id="levelNum">1</span> — <span class="hearts" id="lifeDisplay">❤❤❤</span> — ❤️ <span id="col">0</span>/<span id="colGoal">5</span></div>
  <div class="hint">← → пробел / ↑ — движение и прыжок</div>

  <div class="touch-controls"><div class="btn" id="leftBtn">◀</div><div class="btn" id="rightBtn">▶</div></div>
  <div class="jump-wrap"><div class="btn small" id="jumpBtn">⤴</div></div>

  <div class="overlay">
    <div class="card" id="menuCard"><h1>Love Quest</h1><p>Выбирай уровень (открываются по мере прохождения):</p><div class="menuList" id="levelsList"></div><button class="primary" id="startBtn">Начать с начала</button></div>

    <div class="card" id="levelCompleteCard" style="display:none"><h1>Уровень пройден!</h1><p>Молодец — хочешь перейти дальше или в меню?</p><div style="display:flex;gap:10px;justify-content:center;margin-top:12px"><button class="primary" id="nextBtn">Далее ▶</button><button class="levelBtn" id="backToMenu">В меню</button></div></div>

    <div class="card" id="lostCard" style="display:none"><h1>Ты проиграл</h1><p>Не беда — попробовать снова?</p><div style="display:flex;gap:10px;justify-content:center;margin-top:12px"><button class="primary" id="retryBtn">Попробовать снова</button><button class="levelBtn" id="lostToMenu">В меню</button></div></div>

    <div class="card" id="finalCard" style="display:none"><h1>Ты прошла все уровни!</h1><img src="photo.jpg" alt="Фото" class="finalPhoto"><p>Я не знаю, как объяснить, но каждый день с тобой — мой лучший уровень ❤️</p><button class="primary" id="replayBtn">Играть снова</button></div>
  </div>

  <audio id="music" src="music.mp3" preload="auto"></audio>

<script>
/* === PART 1 — core + level loading + HUD + safety checks for false level complete === */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;
const player = { x:80, y:350, w:36, h:56, vx:0, vy:0, onGround:false, facing:1, lives:3, invUntil:0 };
const gravity = 0.9, friction = 0.85;
const levels = [
  { safeStart:80, platforms:[{x:0,y:460,w:900,h:60},{x:160,y:380,w:180,h:18},{x:360,y:320,w:180,h:18},{x:560,y:260,w:160,h:18},{x:760,y:200,w:140,h:18}], pieces:[{x:220,y:340},{x:420,y:280},{x:620,y:220},{x:760,y:160},{x:480,y:420}]},
  { safeStart:80, platforms:[{x:0,y:480,w:900,h:60},{x:120,y:420,w:200,h:18},{x:360,y:360,w:160,h:18},{x:560,y:300,w:140,h:18},{x:720,y:240,w:140,h:18}], pieces:[{x:160,y:380},{x:380,y:320},{x:600,y:260},{x:740,y:200},{x:440,y:440}]},
  { safeStart:80, platforms:[{x:0,y:500,w:900,h:60},{x:80,y:440,w:140,h:18},{x:240,y:380,w:140,h:18},{x:420,y:340,w:160,h:18},{x:600,y:300,w:160,h:18},{x:760,y:240,w:120,h:18}], pieces:[{x:120,y:420},{x:300,y:360},{x:500,y:320},{x:680,y:280},{x:820,y:200}], hazards:[{x:500,y:480,w:40,h:20},{x:720,y:480,w:40,h:20}]}];
let currentLevel = 0;
let levelsUnlocked = 1;
let platforms = [], pieces = [];
let finished = false;
const music = document.getElementById('music');
music.loop = false;
let levelStartTime = 0;
let levelStartX = 0;
let levelStartY = 0;
let levelCompleteTimeoutId = null;
function resetPlayerTo(levelIdx){
  player.x = levels[levelIdx].safeStart;
  player.y = 300;
  player.vx = 0; player.vy = 0; player.onGround = false;
  player.invUntil = Date.now() + 600;
  levelStartTime = Date.now();
  levelStartX = player.x;
  levelStartY = player.y;
}
function loadLevel(n){
  if(levelCompleteTimeoutId){ clearTimeout(levelCompleteTimeoutId); levelCompleteTimeoutId = null; }
  currentLevel = Math.max(0, Math.min(n, levels.length - 1));
  platforms = JSON.parse(JSON.stringify(levels[currentLevel].platforms || []));
  pieces = (levels[currentLevel].pieces || []).map(p => ({ x: p.x, y: p.y, collected: false }));
  resetPlayerTo(currentLevel);
  finished = false;
  updateHUD();
}
function updateHUD(){
  document.getElementById('levelNum').textContent = currentLevel + 1;
  document.getElementById('col').textContent = pieces.filter(p => p.collected).length;
  document.getElementById('colGoal').textContent = pieces.length;
  const hd = document.getElementById('lifeDisplay');
  hd.innerHTML = '';
  for(let i=0;i<player.lives;i++) hd.innerHTML += '❤';
}
function hideAll(){ document.querySelectorAll('.card').forEach(c=>{ c.classList.remove('show'); c.style.display='none'; }); }
function refreshMenu(){
  const list = document.getElementById('levelsList');
  list.innerHTML = '';
  for(let i=0;i<levels.length;i++){
    const b = document.createElement('button');
    b.className = 'levelBtn';
    b.textContent = 'Уровень '+(i+1);
    b.disabled = i+1 > levelsUnlocked;
    b.style.opacity = i+1 > levelsUnlocked ? 0.45 : 1;
    b.onclick = () => { hideAll(); loadLevel(i); };
    list.appendChild(b);
  }
}
function showMenu(){ hideAll(); refreshMenu(); const c = document.getElementById('menuCard'); c.style.display = 'block'; setTimeout(()=>c.classList.add('show'),10); }
function showLevelComplete(){
  hideAll();
  const c = document.getElementById('levelCompleteCard');
  c.style.display = 'block';
  setTimeout(()=>c.classList.add('show'),10);
}
function showFinal(){
  hideAll();
  const c = document.getElementById('finalCard'); c.style.display = 'block';
  setTimeout(()=>c.classList.add('show'),10);
  try{ music.currentTime = 0; music.play().catch(()=>{}); }catch(e){}
}
loadLevel(0);
showMenu();

/* === PART 2 — movement, physics, collisions, collectibles, and level completion === */
const keys = { left: false, right: false, up: false };
document.addEventListener('keydown', e => {
  if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
  if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
  if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') jump();
});
document.addEventListener('keyup', e => {
  if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
  if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
});
document.getElementById('leftBtn').ontouchstart = () => keys.left = true;
document.getElementById('leftBtn').ontouchend = () => keys.left = false;
document.getElementById('rightBtn').ontouchstart = () => keys.right = true;
document.getElementById('rightBtn').ontouchend = () => keys.right = false;
document.getElementById('jumpBtn').ontouchstart = () => jump();
function jump() {
  if (player.onGround) {
    player.vy = -15;
    player.onGround = false;
  }
}
function updatePlayer() {
  if (keys.left) player.vx -= 0.8;
  if (keys.right) player.vx += 0.8;
  player.vx *= friction;
  player.vy += gravity;
  if (player.vx > 8) player.vx = 8;
  if (player.vx < -8) player.vx = -8;
  if (player.vy > 20) player.vy = 20;
  player.x += player.vx;
  player.y += player.vy;
  player.onGround = false;
  for (let p of platforms) {
    if (player.x < p.x + p.w && player.x + player.w > p.x && player.y < p.y + p.h && player.y + player.h > p.y) {
      if (player.vy > 0 && player.y + player.h - player.vy <= p.y) {
        player.y = p.y - player.h;
        player.vy = 0;
        player.onGround = true;
      }
    }
  }
  if (player.x < 0) player.x = 0;
  if (player.x + player.w > W) player.x = W - player.w;
  if (player.y > H + 200) loseLife();
  for (let item of pieces) {
    if (!item.collected && player.x < item.x + 24 && player.x + player.w > item.x && player.y < item.y + 24 && player.y + player.h > item.y) {
      item.collected = true;
      updateHUD();
    }
  }
  const allCollected = pieces.every(p => p.collected);
  if (allCollected && !finished) {
    const sinceStart = Date.now() - levelStartTime;
    const movedEnough = Math.abs(player.x - levelStartX) > 5 || Math.abs(player.y - levelStartY) > 5;
    if (sinceStart > 800 && movedEnough) {
      finished = true;
      levelCompleteTimeoutId = setTimeout(() => {
        if (currentLevel < levels.length - 1) {
          levelsUnlocked = Math.max(levelsUnlocked, currentLevel + 2);
          showLevelComplete();
        } else {
          showFinal();
        }
      }, 500);
    }
  }
}
function loseLife() {
  if (Date.now() < player.invUntil) return;
  player.lives--;
  player.invUntil = Date.now() + 1500;
  if (player.lives <= 0) {
    showLost();
  } else {
    resetPlayerTo(currentLevel);
  }
  updateHUD();
}
function showLost() {
  hideAll();
  const c = document.getElementById('lostCard');
  c.style.display = 'block';
  setTimeout(() => c.classList.add('show'), 10);
}
function gameLoop() {
  updatePlayer();
  draw();
  requestAnimationFrame(gameLoop);
}
gameLoop();

/* === PART 3 — rendering and visuals === */
function draw() {
  ctx.clearRect(0, 0, W, H);
  const gradient = ctx.createLinearGradient(0, 0, 0, H);
  gradient.addColorStop(0, "#b8e0ff");
  gradient.addColorStop(1, "#f7d2aa");
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, W, H);
  ctx.fillStyle = "#6a4c93";
  for (let p of platforms) ctx.fillRect(p.x, p.y, p.w, p.h);
  for (let item of pieces) {
    if (!item.collected) {
      ctx.fillStyle = "#ff4f6d";
      ctx.beginPath();
      ctx.arc(item.x + 12, item.y + 12, 10, 0, Math.PI * 2);
      ctx.fill();
    }
  }
  const hz = levels[currentLevel].hazards || [];
  ctx.fillStyle = "#ff0000";
  for (let h of hz) ctx.fillRect(h.x, h.y, h.w, h.h);
  ctx.fillStyle = "#00bcd4";
  ctx.fillRect(player.x, player.y, player.w, player.h);
}

/* === PART 4 — UI buttons, audio, and final event handlers === */
document.getElementById('startBtn').onclick = () => { hideAll(); loadLevel(0); };
document.getElementById('nextBtn').onclick = () => { hideAll(); loadLevel(currentLevel + 1); };
document.getElementById('backToMenu').onclick = showMenu;
document.getElementById('retryBtn').onclick = () => { hideAll(); loadLevel(currentLevel); };
document.getElementById('lostToMenu').onclick = showMenu;
document.getElementById('replayBtn').onclick = () => { hideAll(); loadLevel(0); };
music.addEventListener("ended", () => {
  const finalVisible = document.getElementById("finalCard").style.display === "block";
  if (finalVisible) {
    music.currentTime = 0;
    music.play().catch(()=>{});
  }
});
</script>
</body>
</html>