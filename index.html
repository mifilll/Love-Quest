<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Love Quest — polished</title>
  <style>
    /* Общие базовые стили — фон страницы и центрирование холста */
    html,body{height:100%;margin:0;background:#0b1020;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    #gameWrap{display:flex;align-items:center;justify-content:center;height:100%;padding:18px}
    /* Канвас — скруглённый, тень, пропорции */
    canvas{background:linear-gradient(#ff9f6b,#6a86ff);border-radius:14px;box-shadow:0 30px 60px rgba(0,0,0,.45);display:block}
    /* HUD и подсказки */
    .hud{position:fixed;left:16px;top:12px;background:rgba(255,255,255,.95);padding:10px 14px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.12);font-weight:700;z-index:20}
    .hint{position:fixed;right:16px;top:12px;background:rgba(255,255,255,.95);padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.06);z-index:20}
    /* Сенсорные контролы (мобильные) */
    .touch-controls{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;align-items:center;z-index:20}
    .btn{width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,.95);box-shadow:0 10px 30px rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;font-size:24px;user-select:none;touch-action:manipulation}
    .btn.small{width:56px;height:56px}
    .jump-wrap{position:fixed;right:12px;bottom:20px;z-index:20}
    /* Оверлейные карточки меню/результатов */
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:50}
    .card{width:92%;max-width:780px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.28);text-align:center;pointer-events:auto;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);opacity:0;transition:all .25s ease}
    .card.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
    .finalPhoto{width:220px;height:220px;border-radius:14px;object-fit:cover;display:block;margin:14px auto}
    button.primary{background:#ff6b8a;border:none;color:#fff;padding:10px 18px;border-radius:10px;font-weight:700;cursor:pointer}
    .levelBtn{background:#fff;border:2px solid #eee;padding:10px 14px;border-radius:10px;cursor:pointer}
    .menuList{display:flex;gap:12px;justify-content:center;margin:14px 0;flex-wrap:wrap}
    .hearts{display:inline-flex;gap:6px;vertical-align:middle}
    /* responsive */
    @media (max-width:640px){.btn{width:56px;height:56px}}
  </style>
</head>
<body>
  <div id="gameWrap"><canvas id="game" width="900" height="520"></canvas></div>

  <div class="hud" id="hud">Уровень: <span id="levelNum">1</span> — <span class="hearts" id="lifeDisplay">❤❤❤</span> — ❤️ <span id="col">0</span>/<span id="colGoal">5</span></div>
  <div class="hint">← → пробел / ↑ — движение и прыжок</div>

  <div class="touch-controls"><div class="btn" id="leftBtn">◀</div><div class="btn" id="rightBtn">▶</div></div>
  <div class="jump-wrap"><div class="btn small" id="jumpBtn">⤴</div></div>

  <div class="overlay">
    <div class="card" id="menuCard"><h1>Love Quest</h1><p>Выбирай уровень (открываются по мере прохождения):</p><div class="menuList" id="levelsList"></div><button class="primary" id="startBtn">Начать с начала</button></div>

    <div class="card" id="levelCompleteCard" style="display:none"><h1>Уровень пройден!</h1><p>Молодец — хочешь перейти дальше или в меню?</p><div style="display:flex;gap:10px;justify-content:center;margin-top:12px"><button class="primary" id="nextBtn">Далее ▶</button><button class="levelBtn" id="backToMenu">В меню</button></div></div>

    <div class="card" id="lostCard" style="display:none"><h1>Ты проиграл</h1><p>Не беда — попробовать снова?</p><div style="display:flex;gap:10px;justify-content:center;margin-top:12px"><button class="primary" id="retryBtn">Попробовать снова</button><button class="levelBtn" id="lostToMenu">В меню</button></div></div>

    <div class="card" id="finalCard" style="display:none"><h1>Ты прошла все уровни!</h1><img src="" id="finalImg" alt="Фото" class="finalPhoto"><p>Я не знаю, как объяснить, но каждый день с тобой — мой лучший уровень ❤️</p><button class="primary" id="replayBtn">Играть снова</button></div>
  </div>

  <!-- Музыка: локального файла нет — браузер может блокировать автоплей; при желании можно заменить src на встроенный base64 -->
  <audio id="music" src="music.mp3" preload="auto"></audio>

<script>
/* === CORE STATE & LEVELS === */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

/* Игрок */
const player = { x:80, y:350, w:36, h:56, vx:0, vy:0, onGround:false, facing:1, lives:3, invUntil:0 };

/* Физика */
const gravity = 0.9, friction = 0.85;

/* Уровни */
const levels = [
  { safeStart:80, platforms:[{x:0,y:460,w:900,h:60},{x:160,y:380,w:180,h:18},{x:360,y:320,w:180,h:18},{x:560,y:260,w:160,h:18},{x:760,y:200,w:140,h:18}], pieces:[{x:220,y:340},{x:420,y:280},{x:620,y:220},{x:760,y:160},{x:480,y:420}]},
  { safeStart:80, platforms:[{x:0,y:480,w:900,h:60},{x:120,y:420,w:200,h:18},{x:360,y:360,w:160,h:18},{x:560,y:300,w:140,h:18},{x:720,y:240,w:140,h:18}], pieces:[{x:160,y:380},{x:380,y:320},{x:600,y:260},{x:740,y:200},{x:440,y:440}]},
  { safeStart:80, platforms:[{x:0,y:500,w:900,h:60},{x:80,y:440,w:140,h:18},{x:240,y:380,w:140,h:18},{x:420,y:340,w:160,h:18},{x:600,y:300,w:160,h:18},{x:760,y:240,w:120,h:18}], pieces:[{x:120,y:420},{x:300,y:360},{x:500,y:320},{x:680,y:280},{x:820,y:200}], hazards:[{x:480,y:500,w:40,h:20},{x:720,y:500,w:40,h:20},{x:360,y:500,w:40,h:20}]}
];

let currentLevel = 0;
let levelsUnlocked = 1;
let platforms = [], pieces = [];
let finished = false;

const music = document.getElementById('music');
music.loop = false;
let levelStartTime = 0;
let levelStartX = 0;
let levelStartY = 0;
let levelCompleteTimeoutId = null;

function resetPlayerTo(levelIdx){
  player.x = levels[levelIdx].safeStart;
  player.y = 300;
  player.vx = 0; player.vy = 0; player.onGround = false;
  player.invUntil = Date.now() + 600;
  levelStartTime = Date.now();
  levelStartX = player.x;
  levelStartY = player.y;
}

function loadLevel(n){
  if(levelCompleteTimeoutId){ clearTimeout(levelCompleteTimeoutId); levelCompleteTimeoutId = null; }
  currentLevel = Math.max(0, Math.min(n, levels.length - 1));
  platforms = JSON.parse(JSON.stringify(levels[currentLevel].platforms || []));
  pieces = (levels[currentLevel].pieces || []).map(p => ({ x: p.x, y: p.y, collected: false }));
  finished = false;
  resetPlayerTo(currentLevel);
  updateHUD();
  try{ music.pause(); music.currentTime = 0; }catch(e){}
}

function updateHUD(){
  document.getElementById('levelNum').textContent = currentLevel + 1;
  document.getElementById('col').textContent = pieces.filter(p => p.collected).length;
  document.getElementById('colGoal').textContent = pieces.length;
  const hd = document.getElementById('lifeDisplay');
  hd.innerHTML = '';
  for(let i=0;i<player.lives;i++) hd.innerHTML += '❤';
}

function hideAll(){ document.querySelectorAll('.card').forEach(c=>{ c.classList.remove('show'); c.style.display='none'; }); }
function refreshMenu(){
  const list = document.getElementById('levelsList');
  list.innerHTML = '';
  for(let i=0;i<levels.length;i++){
    const b = document.createElement('button');
    b.className = 'levelBtn';
    b.textContent = 'Уровень '+(i+1);
    b.disabled = i+1 > levelsUnlocked;
    b.style.opacity = i+1 > levelsUnlocked ? 0.45 : 1;
    b.onclick = () => { hideAll(); loadLevel(i); };
    list.appendChild(b);
  }
}
function showMenu(){ hideAll(); refreshMenu(); const c = document.getElementById('menuCard'); c.style.display = 'block'; setTimeout(()=>c.classList.add('show'),10); }
function showLevelComplete(){
  hideAll();
  const c = document.getElementById('levelCompleteCard');
  c.style.display = 'block';
  setTimeout(()=>c.classList.add('show'),10);
}
function showFinal(){
  hideAll();
  const c = document.getElementById('finalCard'); c.style.display = 'block';
  setTimeout(()=>c.classList.add('show'),10);
  try{ music.currentTime = 0; music.play().catch(()=>{}); }catch(e){}
}

/* Инициализация */
loadLevel(0);
showMenu();
</script>

<script>
/* INPUT & PHYSICS */
const keys = { left: false, right: false, up: false };
document.addEventListener('keydown', e => {
  if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
  if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
  if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') jump();
});
document.addEventListener('keyup', e => {
  if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
  if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
});
document.getElementById('leftBtn').ontouchstart = () => keys.left = true;
document.getElementById('leftBtn').ontouchend = () => keys.left = false;
document.getElementById('rightBtn').ontouchstart = () => keys.right = true;
document.getElementById('rightBtn').ontouchend = () => keys.right = false;
document.getElementById('jumpBtn').ontouchstart = () => jump();

function jump() {
  if (player.onGround) {
    player.vy = -15;
    player.onGround = false;
  }
}

function updatePlayer() {
  if (keys.left) { player.vx -= 0.8; player.facing = -1; }
  if (keys.right) { player.vx += 0.8; player.facing = 1; }
  player.vx *= friction;
  player.vy += gravity;
  if (player.vx > 8) player.vx = 8;
  if (player.vx < -8) player.vx = -8;
  if (player.vy > 20) player.vy = 20;
  player.x += player.vx;
  player.y += player.vy;
  player.onGround = false;

  for (let p of platforms) {
    if (player.x < p.x + p.w && player.x + player.w > p.x && player.y < p.y + p.h && player.y + player.h > p.y) {
      if (player.vy > 0 && (player.y + player.h - player.vy) <= p.y + 2) {
        player.y = p.y - player.h;
        player.vy = 0;
        player.onGround = true;
      } else {
        if (player.x + player.w/2 < p.x + p.w/2) {
          player.x = p.x - player.w - 0.1;
          player.vx = 0;
        } else {
          player.x = p.x + p.w + 0.1;
          player.vx = 0;
        }
      }
    }
  }

  if (player.x < 0) player.x = 0;
  if (player.x + player.w > W) player.x = W - player.w;
  if (player.y > H + 200) loseLife();

  for (let item of pieces) {
    if (!item.collected) {
      const cx = item.x + 12, cy = item.y + 12;
      const px = player.x + player.w/2, py = player.y + player.h/2;
      const dx = cx - px, dy = cy - py;
      if (Math.hypot(dx, dy) < 34) {
        item.collected = true;
        updateHUD();
      }
    }
  }

  const hz = levels[currentLevel].hazards || [];
  for (let h of hz) {
    if (player.x < h.x + h.w && player.x + player.w > h.x && player.y < h.y + h.h && player.y + player.h > h.y) {
      if (Date.now() >= player.invUntil) {
        player.invUntil = Date.now() + 900;
        player.lives--;
        updateHUD();
        if (player.lives <= 0) {
          showLost();
        } else {
          resetPlayerTo(currentLevel);
        }
      }
    }
  }

  const allCollected = pieces.every(p => p.collected);
  if (allCollected && !finished) {
    const sinceStart = Date.now() - levelStartTime;
    const movedEnough = Math.abs(player.x - levelStartX) > 5 || Math.abs(player.y - levelStartY) > 5;
    if (sinceStart > 800 && movedEnough) {
      finished = true;
      levelCompleteTimeoutId = setTimeout(() => {
        const wantUnlock = Math.min(levels.length, currentLevel + 2);
        levelsUnlocked = Math.max(levelsUnlocked, wantUnlock);
        if (currentLevel < levels.length - 1) {
          showLevelComplete();
        } else {
          showFinal();
        }
      }, 500);
    }
  }
}

function loseLife() {
  if (Date.now() < player.invUntil) return;
  player.lives--;
  player.invUntil = Date.now() + 1500;
  if (player.lives <= 0) {
    showLost();
  } else {
    resetPlayerTo(currentLevel);
  }
  updateHUD();
}

function showLost() {
  hideAll();
  const c = document.getElementById('lostCard');
  c.style.display = 'block';
  setTimeout(() => c.classList.add('show'), 10);
}

function gameLoop() {
  updatePlayer();
  draw();
  requestAnimationFrame(gameLoop);
}
gameLoop();
</script>

<script>
/* RENDERING & VISUALS */
const clouds = [];
for (let i=0;i<8;i++){
  clouds.push({ x: Math.random()*W, y: 40 + Math.random()*120, w: 140 + Math.random()*120, h: 40 + Math.random()*20, speed: 0.2 + Math.random()*0.6, alpha: 0.4 + Math.random()*0.4 });
}

function drawBackground(){
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, "#0f1b3d");
  grad.addColorStop(0.4, "#6b3b8a");
  grad.addColorStop(0.7, "#ff8a6b");
  grad.addColorStop(1, "#ffd9a6");
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,W,H);

  for (let i=0;i<3;i++){
    ctx.globalAlpha = 0.03;
    ctx.beginPath();
    ctx.ellipse(W*0.3 + i*160, H*0.75 - i*20, 280, 120, Math.PI/6, 0, Math.PI*2);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  ctx.beginPath();
  ctx.globalAlpha = 0.12;
  ctx.fillStyle = "#ffdfa8";
  ctx.arc(W - 130, H - 80, 120, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;
}

function drawClouds(dt){
  for (let c of clouds){
    c.x += c.speed * dt * 0.04;
    if (c.x - c.w > W) c.x = -c.w - (Math.random()*60);
    ctx.globalAlpha = c.alpha;
    ctx.beginPath();
    ctx.fillStyle = "#ffffff";
    ctx.ellipse(c.x, c.y, c.w*0.6, c.h, 0, 0, Math.PI*2);
    ctx.ellipse(c.x + c.w*0.3, c.y + 6, c.w*0.5, c.h*0.9, 0, 0, Math.PI*2);
    ctx.ellipse(c.x - c.w*0.28, c.y + 4, c.w*0.46, c.h*0.9, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }
}

function drawPlatforms(){
  for (let p of platforms){
    ctx.fillStyle = "rgba(0,0,0,0.18)";
    ctx.fillRect(p.x+6, p.y+6, p.w, p.h);
    ctx.fillStyle = "#6a4c93";
    ctx.fillRect(p.x, p.y, p.w, p.h);
    ctx.strokeStyle = "rgba(255,255,255,0.06)";
    ctx.strokeRect(p.x+0.5, p.y+0.5, p.w-1, p.h-1);
  }
}

function drawHeart(x,y,scale=1){
  ctx.save();
  ctx.translate(x, y);
  ctx.scale(scale, scale);
  ctx.beginPath();
  ctx.moveTo(12, 20);
  ctx.bezierCurveTo(12, 20, 2, 12, 6, 6);
  ctx.bezierCurveTo(9, 0, 18, 0, 22, 6);
  ctx.bezierCurveTo(26, 12, 16, 20, 16, 20);
  ctx.fillStyle = "#ff4f6d";
  ctx.fill();
  ctx.fillStyle = "rgba(255,255,255,0.5)";
  ctx.beginPath();
  ctx.ellipse(7,8,3,2, -0.3, 0, Math.PI*2);
  ctx.fill();
  ctx.restore();
}

function drawSpikes(){
  const hz = levels[currentLevel].hazards || [];
  for (let h of hz){
    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,0.12)";
    ctx.fillRect(h.x+2, h.y+6, h.w, 6);
    const spikeW = h.w / 2;
    for (let tx = h.x; tx < h.x + h.w - 1; tx += spikeW){
      ctx.beginPath();
      ctx.moveTo(tx, h.y + h.h);
      ctx.lineTo(tx + spikeW/2, h.y);
      ctx.lineTo(tx + spikeW, h.y + h.h);
      ctx.closePath();
      ctx.fillStyle = "#b70b0b";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.stroke();
    }
    ctx.restore();
  }
}

function drawPlayer(){
  const x = player.x, y = player.y, w = player.w, h = player.h;
  ctx.save();
  ctx.beginPath();
  ctx.ellipse(x + w/2, y + h + 6, w*0.8, 8, 0, 0, Math.PI*2);
  ctx.fillStyle = "rgba(0,0,0,0.18)";
  ctx.fill();

  ctx.fillStyle = "#2b6b8f";
  ctx.fillRect(x + 6, y + 20, w - 12, h - 28);
  ctx.fillStyle = "#2a2a2a";
  ctx.fillRect(x + 6, y + h - 6, (w - 12)/2 - 2, 6);
  ctx.fillRect(x + 6 + (w - 12)/2 + 2, y + h - 6, (w - 12)/2 - 2, 6);

  ctx.beginPath();
  ctx.arc(x + w/2, y + 12, 12, 0, Math.PI*2);
  ctx.fillStyle = "#f6d3b5";
  ctx.fill();

  ctx.beginPath();
  ctx.moveTo(x + w/2 - 12, y + 6);
  ctx.quadraticCurveTo(x + w/2, y - 6, x + w/2 + 12, y + 6);
  ctx.lineTo(x + w/2 + 12, y + 12);
  ctx.quadraticCurveTo(x + w/2, y + 2, x + w/2 - 12, y + 12);
  ctx.closePath();
  ctx.fillStyle = "#6f3a1e";
  ctx.fill();

  ctx.fillStyle = "#222";
  ctx.fillRect(x + w/2 - 6, y + 8, 3, 2);
  ctx.fillRect(x + w/2 + 4, y + 8, 3, 2);

  ctx.restore();
}

let lastTime = performance.now();
function draw(){
  const now = performance.now();
  const dt = (now - lastTime) || 16;
  lastTime = now;

  drawBackground();
  drawClouds(dt);
  drawPlatforms();
  drawSpikes();
  for (let item of pieces) {
    if (!item.collected) {
      drawHeart(item.x, item.y, 1);
    }
  }
  drawPlayer();

  ctx.fillStyle = "rgba(255,255,255,0.12)";
  ctx.fillRect(8, H - 30, 140, 22);
  ctx.fillStyle = "#fff";
  ctx.font = "13px sans-serif";
  ctx.fillText(`FPS: ${Math.round(1000/dt)}`, 14, H - 14);
}
</script>

<script>
/* UI & BUTTONS */
document.getElementById('startBtn').onclick = () => { hideAll(); loadLevel(0); };
document.getElementById('nextBtn').onclick = () => { hideAll(); loadLevel(currentLevel + 1); };
document.getElementById('backToMenu').onclick = () => { showMenu(); };
document.getElementById('retryBtn').onclick = () => { hideAll(); loadLevel(currentLevel); };
document.getElementById('lostToMenu').onclick = () => { showMenu(); };
document.getElementById('replayBtn').onclick = () => { hideAll(); loadLevel(0); };

music.addEventListener("ended", () => {
  const finalVisible = document.getElementById("finalCard").style.display === "block";
  if (finalVisible) {
    try{ music.currentTime = 0; music.play().catch(()=>{}); }catch(e){}
  }
});

document.getElementById('backToMenu').addEventListener('click', () => {
  try{ music.pause(); music.currentTime = 0; }catch(e){}
  refreshMenu();
});

document.getElementById('startBtn').addEventListener('click', ()=>{ try{ music.pause(); music.currentTime = 0; }catch(e){}; });
document.getElementById('replayBtn').addEventListener('click', ()=>{ try{ music.pause(); music.currentTime = 0; }catch(e){}; });

document.addEventListener('click', (e)=>{
  const card = document.querySelector('.card.show');
  if (!card) return;
  if (!card.contains(e.target) && !e.target.matches('.levelBtn') && !e.target.matches('.primary')) {
    // ничего
  }
});

updateHUD();
</script>
</body>
</html>
